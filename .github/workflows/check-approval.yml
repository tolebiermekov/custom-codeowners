name: Check PR Approval

on:
  pull_request_review:
    types: [submitted]

permissions:
  pull-requests: read
  contents: read

jobs:
  check-approvals:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: pip install pathspec

      - name: Check Approvals
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python - <<EOF
          import os
          import sys
          import json
          # ⬇️ УДАЛИТЕ 'pathspec' ⬇️
          # import pathspec
          
          # ⬇️ ДОБАВЬТЕ 'fnmatch' ⬇️
          import fnmatch
          
          import urllib.request
          import urllib.error
          
          def fail(message):
              print(f"::error::{message}")
              sys.exit(1)
          
          # ... (весь код make_request, context, и парсер CODEOWNERS-DWH) ...
          # ... (весь код get changed files и get reviews) ...
          
          
          # -----------------------------------------------------------------
          # ⬇️⬇️⬇️ ПОЛНОСТЬЮ НОВАЯ ЛОГИКА ПРОВЕРКИ ⬇️⬇️⬇️
          # -----------------------------------------------------------------
          
          # Checking logic
          all_files_covered = True
          uncovered_files = []
          
          for file in changed_files:
              print(f"\nDEBUG: Checking file: {file}")
              last_match_owners = None
          
              # Last Match Wins
              for rule in rules:
          
                  # Используем fnmatch вместо pathspec
                  # 'pattern' из нашего парсера уже готов (например, 'config/other/')
                  if fnmatch.fnmatch(file, rule['pattern']) or \
                     (rule['pattern'].endswith('/') and file.startswith(rule['pattern'])):
          
                      last_match_owners = rule['owners']
                      print(f"DEBUG: -> Matched pattern '{rule['pattern']}', owner is now: {last_match_owners}")
          
              print(f"DEBUG: -> Final owner for {file}: {last_match_owners}")
          
              if not last_match_owners:
                  print(f"File {file} has no owner in CODEOWNERS-DWH. Failing.")
                  all_files_covered = False
                  uncovered_files.append(f"- {file} (has NO owner assigned in CODEOWNERS-DWH)")
                  continue
          
              intersection = approved_users.intersection(last_match_owners)
              if not intersection:
                  all_files_covered = False
                  uncovered_files.append(f"- {file} (requires: {', '.join(last_match_owners)})")
              else:
                  print(f"PR is covered by approval from: {', '.join(intersection)}")
          
          if all_files_covered:
              print("✅ All changed files are covered by owners.")
          else:
              uncovered_files_str = '\n'.join(uncovered_files)
              error_message = (
                  f"❌ Not all files are covered by approval. "
                  f"Approver(s) {', '.join(approved_users)} do not have permissions for:\n"
                  f"{uncovered_files_str}"
              )
              fail(error_message)
          EOF
