name: Check PR Approval

on:
  pull_request_review:
    types: [submitted]

permissions:
  pull-requests: read
  contents: read

jobs:
  check-approvals:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install micromatch
        run: npm install micromatch

      - name: Check Approvals using CODEOWNERS-DWH
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const micromatch = require('micromatch');
            
            const CODEOWNERS_FILE = '.github/CODEOWNERS-DWH';
            const prNumber = context.payload.pull_request.number;
            const repo = context.repo.repo;
            const owner = context.repo.owner;
            
            // --- 1. Парсинг файла CODEOWNERS-DWH (с фиксами) ---
            let rules = [];
            try {
              const fileContent = fs.readFileSync(CODEOWNERS_FILE, 'utf8');
              rules = fileContent.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0 && !line.startsWith('#'))
                .map(line => {
                  const [rawPattern, ...ownerStrings] = line.split(/\s+/);
            
                  // "Переводим" `*` -> `**` и `**/folder/` -> `**/folder/**`
                  const pattern = (rawPattern === '*') 
                                    ? '**' 
                                    : (rawPattern.endsWith('/') && rawPattern.length > 1) 
                                      ? rawPattern + '**' 
                                      : rawPattern;
            
                  const owners = ownerStrings
                    .filter(ownerStr => !ownerStr.includes('/')) 
                    .map(ownerStr => ownerStr.replace('@', ''));
            
                  return { pattern, owners: new Set(owners) }; 
                });
            } catch (error) {
              core.setFailed(`Не удалось прочитать ${CODEOWNERS_FILE}: ${error.message}`);
              return;
            }
            
            // --- 2. Получение всех измененных файлов в PR ---
            const { data: changedFiles } = await github.rest.pulls.listFiles({
              owner, repo, pull_number: prNumber
            });
            const changedFilePaths = changedFiles.map(f => f.filename);
            
            // --- 3. Получение всех, кто нажал "Approve" ---
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner, repo, pull_number: prNumber
            });
            
            const approvedUsers = new Set(
              reviews
                .filter(review => review.state === 'APPROVED')
                .map(review => review.user.login)
            );
            
            if (approvedUsers.size === 0) {
              core.setFailed('❌ Нет ни одного "Approve" на этом PR.');
              return;
            }
            console.log(`Найдено апрувов от: ${[...approvedUsers].join(', ')}`);
            
            // --- 4. НОВАЯ ЛОГИКА: "Per-File" (по-файловая) проверка ---
            
            let allFilesCovered = true;
            const uncoveredFiles = []; // Собираем файлы, которые "не покрыты" апрувом
            const allRequiredOwners = new Set(); // Собираем всех, кто мог бы апрувить
            
            for (const file of changedFilePaths) {
              let lastMatchOwners = null;
              // Ищем "владельцев" файла (Last Match Wins)
              for (const rule of rules) {
                if (micromatch.isMatch(file, rule.pattern)) {
                  lastMatchOwners = rule.owners;
                }
              }
            
              if (!lastMatchOwners || lastMatchOwners.size === 0) {
                // У этого файла нет "владельцев", он не требует апрува
                console.log(`Файл ${file} не требует "владельца". Пропускаем.`);
                continue; 
              }
            
              // Добавляем "владельцев" этого файла в общий список для лога
              lastMatchOwners.forEach(owner => allRequiredOwners.add(owner));
            
              // Проверяем, есть ли "пересечение"
              const intersection = new Set(
                [...approvedUsers].filter(user => lastMatchOwners.has(user))
              );
            
              if (intersection.size === 0) {
                // Ни один из тех, кто апрувил, НЕ МОЖЕТ апрувить ЭТОТ файл!
                allFilesCovered = false;
                uncoveredFiles.push(`- ${file} (требует: ${[...lastMatchOwners].join(', ')})`);
              } else {
                console.log(`Файл ${file} покрыт апрувом от: ${[...intersection].join(', ')}`);
              }
            }
            
            // --- 5. Финальный вердикт ---
            if (allFilesCovered) {
              console.log(`✅ Все измененные файлы покрыты "владельцами".`);
              return; // Успех!
            }
            
            core.setFailed(
              `❌ Не все файлы покрыты апрувом. Апрувер(ы) ${[...approvedUsers].join(', ')} не имеют прав на:\n` +
              uncoveredFiles.join('\n')
            );