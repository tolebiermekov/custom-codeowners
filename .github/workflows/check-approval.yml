name: üõÇ Check PR Approval (CODEOWNERS-DWH)

on:
  pull_request_review:
    types: [submitted]

permissions:
  pull-requests: read
  contents: read

jobs:
  check-approvals:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üì¶ Install micromatch (–¥–ª—è glob-–ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤)
        run: npm install micromatch

      - name: üïµÔ∏è Check Approvals using CODEOWNERS-DWH (Final Fix)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const micromatch = require('micromatch');
            
            const CODEOWNERS_FILE = '.github/CODEOWNERS-DWH';
            const prNumber = context.payload.pull_request.number;
            const repo = context.repo.repo;
            const owner = context.repo.owner;
            
            // --- 1. –ü–∞—Ä—Å–∏–Ω–≥ —Ñ–∞–π–ª–∞ CODEOWNERS-DWH (—Å —Ñ–∏–∫—Å–∞–º–∏) ---
            let rules = [];
            try {
              const fileContent = fs.readFileSync(CODEOWNERS_FILE, 'utf8');
              rules = fileContent.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0 && !line.startsWith('#'))
                .map(line => {
                  const [rawPattern, ...ownerStrings] = line.split(/\s+/);
            
                  // ================================================================
                  // üí° –¢–†–û–ô–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï:
                  // 1. `*` -> `**` (–≥–ª–æ–±–∞–ª—å–Ω—ã–π)
                  // 2. `.../` -> `.../**` (–≤—Å–µ –≤–Ω—É—Ç—Ä–∏)
                  // 3. `/path` -> `path` (—É–±–∏—Ä–∞–µ–º –≤–µ–¥—É—â–∏–π —Å–ª—ç—à)
                  // ================================================================
                  
                  let pattern = (rawPattern === '*') 
                                    ? '**' 
                                    : (rawPattern.endsWith('/') && rawPattern.length > 1) 
                                      ? rawPattern + '**' 
                                      : rawPattern;
                  
                  // –ù–û–í–´–ô –§–ò–ö–°: –£–±–∏—Ä–∞–µ–º –≤–µ–¥—É—â–∏–π —Å–ª—ç—à
                  if (pattern.startsWith('/')) {
                    pattern = pattern.substring(1);
                  }
                  
                  // ================================================================
                  
                  const owners = ownerStrings
                    .filter(ownerStr => !ownerStr.includes('/')) 
                    .map(ownerStr => ownerStr.replace('@', ''));
            
                  return { pattern, owners: new Set(owners) }; 
                });
            } catch (error) {
              core.setFailed(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å ${CODEOWNERS_FILE}: ${error.message}`);
              return;
            }
            
            // --- 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –≤ PR ---
            const { data: changedFiles } = await github.rest.pulls.listFiles({
              owner, repo, pull_number: prNumber
            });
            const changedFilePaths = changedFiles.map(f => f.filename);
            
            // --- 3. –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö, –∫—Ç–æ –Ω–∞–∂–∞–ª "Approve" ---
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner, repo, pull_number: prNumber
            });
            
            const approvedUsers = new Set(
              reviews
                .filter(review => review.state === 'APPROVED')
                .map(review => review.user.login)
            );
            
            if (approvedUsers.size === 0) {
              core.setFailed('‚ùå –ù–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ "Approve" –Ω–∞ —ç—Ç–æ–º PR.');
              return;
            }
            console.log(`–ù–∞–π–¥–µ–Ω–æ –∞–ø—Ä—É–≤–æ–≤ –æ—Ç: ${[...approvedUsers].join(', ')}`);
            
            // --- 4. "Per-File" –ø—Ä–æ–≤–µ—Ä–∫–∞ ---
            
            let allFilesCovered = true;
            const uncoveredFiles = [];
            
            for (const file of changedFilePaths) {
              let lastMatchOwners = null;
              // –ò—â–µ–º "–≤–ª–∞–¥–µ–ª—å—Ü–µ–≤" —Ñ–∞–π–ª–∞ (Last Match Wins)
              for (const rule of rules) {
                if (micromatch.isMatch(file, rule.pattern)) {
                  lastMatchOwners = rule.owners;
                }
              }
            
              if (!lastMatchOwners || lastMatchOwners.size === 0) {
                console.log(`–§–∞–π–ª ${file} –Ω–µ —Ç—Ä–µ–±—É–µ—Ç "–≤–ª–∞–¥–µ–ª—å—Ü–∞". –ü—Ä–æ–ø—É—Å–∫–∞–µ–º.`);
                continue; 
              }
            
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ "–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ"
              const intersection = new Set(
                [...approvedUsers].filter(user => lastMatchOwners.has(user))
              );
            
              if (intersection.size === 0) {
                allFilesCovered = false;
                uncoveredFiles.push(`- ${file} (—Ç—Ä–µ–±—É–µ—Ç: ${[...lastMatchOwners].join(', ')})`);
              } else {
                console.log(`–§–∞–π–ª ${file} –ø–æ–∫—Ä—ã—Ç –∞–ø—Ä—É–≤–æ–º –æ—Ç: ${[...intersection].join(', ')}`);
              }
            }
            
            // --- 5. –§–∏–Ω–∞–ª—å–Ω—ã–π –≤–µ—Ä–¥–∏–∫—Ç ---
            if (allFilesCovered) {
              console.log(`‚úÖ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ø–æ–∫—Ä—ã—Ç—ã "–≤–ª–∞–¥–µ–ª—å—Ü–∞–º–∏".`);
              return; // –£—Å–ø–µ—Ö!
            }
            
            core.setFailed(
              `‚ùå –ù–µ –≤—Å–µ —Ñ–∞–π–ª—ã –ø–æ–∫—Ä—ã—Ç—ã –∞–ø—Ä—É–≤–æ–º. –ê–ø—Ä—É–≤–µ—Ä(—ã) ${[...approvedUsers].join(', ')} –Ω–µ –∏–º–µ—é—Ç –ø—Ä–∞–≤ –Ω–∞:\n` +
              uncoveredFiles.join('\n')
            );